---
title: 3.11 微服务应用安全解决方案
keywords: [ SCA ]
description: 为什么需要微服务安全层出不穷的基础组件的安全漏洞需要及时修复随着微服务的深入，微服务的安全问题日益成为一个企业关注的重点，微服务所依赖的基础框架，操作系统内核，如果出现安全漏洞，随时可能成为一个深水炸弹，对业务系统造成灾难性的破坏。比较典型的例子是，层出不穷的 fastjson 安全漏洞，Du...
---
<a name="ILY1D"></a>
### 为什么需要微服务安全

<a name="N9wTS"></a>
#### 层出不穷的基础组件的安全漏洞需要及时修复
随着微服务的深入，微服务的安全问题日益成为一个企业关注的重点，微服务所依赖的基础框架，操作系统内核，如果出现安全漏洞，随时可能成为一个深水炸弹，对业务系统造成灾难性的破坏。比较典型的例子是，层出不穷的 fastjson 安全漏洞，Dubbo 安全漏洞，以及近期破坏性较大的 log4j 安全漏洞，给企业客户的生产，业务迭代造成了巨大的影响，所有依赖该基础组件的二方包，三方包，都需要通过升级 SDK 的方式修复，微服务规模越大，升级的成本越高。

- 2021年12月10日，国家信息安全漏洞共享平台（CNVD）收录了Apache Log4j2远程代码执行漏洞（CNVD-2021-95914），此漏洞是一个基于Java的日志记录工具，为Log4j的升级。作为目前最优秀的Java日志框架之一，被大量用于业务系统开发。此次危机由Lookup功能引发，Log4j2在默认情况下会开启Lookup功能，提供给客户另一种添加特殊值到日志中的方式。此功能中也包含了对于JNDI的Lookup，但由于Lookup对于加载的JNDI内容未做任何限制，使得攻击者可以通过JNDI注入实现远程加载恶意类到应用中，从而造成RCE。
- 2021年7月1日，Apache Dubbo 社区爆出如下安全漏洞列表：CVE-2021-25641，等级【高】。Hessian2 协议反序列化漏洞，攻击者以篡改协议的方式绕过反序列化黑/白名单；CVE-2021-30179，等级【高】。Generic Filter 远程代码执行漏洞，启用泛化调用的用户，可能会受到恶意伪造的参数的攻击；CVE-2021-32824，等级【高】。Telnet handler远程代码执行漏洞，恶意攻击者可能通过 Telnet 接口构造相关请求进行攻击；CVE-2021-30180，等级【低】。YAML 规则加载造成的远程代码执行漏洞，攻击者在攻破配置中心后，可通过上传恶意的 yaml 规则等触发反序列化漏洞；CVE-2021-30181，等级【低】。Nashorn 脚本远程代码执行漏洞，攻击者在攻破配置中心后，可通过上传恶意的 script 规则等来触发 Nashorn 脚本执行攻击。


<a name="u3QE9"></a>
#### 微服务之间的调用需要安全可信
我们对于数据库通常都会做严格的权限控制，但是由于我们的微服务对数据库是拥有完全的访问权限的，所以即使数据库层面做了非常严格的权限控制，一旦微服务层面突破了，也会对数据库造成灾难性的破坏，例如一个黑客，假设具备了微服务的访问权限，可能会发生拖库等严重问题。因此微服务之间的调用也需要严格的而控制安全可信。

<a name="YqQPp"></a>
#### 业务配置安全
我们对于一些重要的配置，通常会放在统一的配置中心，这里面就包含了一些敏感数据，例如数据库的访问用户名和密码，然后通常的配置中心的配置，大家是可以随意访问的，如果让无权访问改数据库的用户拿到了这些敏感数据，则他也可能会获取到数据库中的敏感数据。因此业务配置也需要进行安全的授权访问。


<a name="x8jHQ"></a>
### 微服务安全解决方案


<a name="eB6qG"></a>
#### 漏洞防护
![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/10501/1644551574752-cc577ee3-a69e-4c99-8417-0bd2b98bbbc3.png#clientId=ue269975f-b0d0-4&from=paste&height=574&id=ue3710beb&originHeight=574&originWidth=1271&originalType=binary&ratio=1&rotation=0&showTitle=false&size=209906&status=done&style=none&taskId=ua6693f5b-98f6-4f4c-862b-1d1cd62b657&title=&width=1271)<br />![第十一章_3-11-1 第三章第十一节第一张图.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/54319/1648211484730-87605a24-c283-414d-8d5d-80608a855db5.png#clientId=u6ebc176c-d047-4&from=ui&id=uc07281dd&originHeight=381&originWidth=690&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41458&status=done&style=none&taskId=udd82f797-ba5d-417f-951f-ad4f8e5073d&title=)

通常我们在入口处通过 WAF 提供入口层的防护，可以提供 SQL注入、XSS、代码执行、文件包含、webshell等通用 web 漏洞利用防御能力，入口层安全防护更加适用于 CC攻击/爬虫/扫描、流量访问控制、数据泄露检测等场景，但入口层防护也有一定的局限性，入口层防护完全基于流量特征进行检测，容易产生大量无效报警或因担心误报规则不敢做太严格，这给安全运维会带来一些负担，某用户在在线文档中上传一段SQL语句，容易产生误报；再如，利用 php 漏洞的报文打到了Java 环境中，实际 Java 应用不受影响，这也容易产生虚报。<br />再者，基于流量特征的防护只能看到流量内容，即用户的原始请求，并不能感知应用最终会怎样执行这条请求，有一些比较隐蔽的攻击，可能会通过变形的请求绕过流量特征的检测。

在应用层我们推荐使用应用层防护 RASP 技术来进行防护，RASP 全称 Runtime Application Self Protection，是一种在运行时检测应用程序攻击并进行自我保护的安全产品。RASP 通过 Java Agent 方式挂载到微服务系统中，无需修改任何业务代码，对业务侵入性较低。RASP 能看到应用的上下文，理解应用最终执行了什么动作和命令，不管原始请求怎样变形，最终应用执行的动作是不变的，例如要执行 `cat /etc/passwd` 命令，无论流量特征如何变形，最后都会落到这个执行动作上。RASP 还能理解是什么应用做了什么动作（身份+行为），只要身份和行为不匹配，就可以检测到异常。对于一些加密马等手段，本质上也是对输入内容做变形以绕过基于特征的检测，RASP 同理也能都抵抗。


<a name="Zb6Cq"></a>
#### 零信任安全

针对 Java 微服务应用，基于字节码增强的方案，提供无侵入的0信任方案，接入统一治理平台后，每个微服务的调用方都具有身份，微服务调用过程中，每次请求都会带上该应用的身份，而通过服务治理平台，可以灵活控制针对每个应用配置访问策略：

- 从访问方式上，可以通过黑白名单的方式来进行配置。例如，可以配置只允许来自某些特定应用的请求访问自身提供的接口，通常我们称为白名单，也可以配置除了某些应用，其他应用都可以访问，通常我们成为黑名单。
- 从访问粒度上，针对 Spring Cloud 类型的微服务，可以控制访问微服务的某一个具体的 URL,  针对 Dubbo 类型的接口维度的微服务框架，可以支持控制访问微服务的某一个具体的接口。

<a name="v17D0"></a>
#### 配置鉴权

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/10501/1644812402646-6f050a9e-54ac-4038-945a-3a866d2ab3aa.png#clientId=u45fdfe70-f610-4&from=paste&height=472&id=u8d5185ed&originHeight=472&originWidth=970&originalType=binary&ratio=1&rotation=0&showTitle=false&size=129235&status=done&style=none&taskId=uf194dc29-e197-4fc0-ac52-34b1ce0b592&title=&width=970)<br />![第十一章_3-11-2 第三章第十一节第二 张图.png](https://intranetproxy.alipay.com/skylark/lark/0/2022/png/54319/1648211500228-2e5e0097-2453-49bc-b607-eae13ba0774d.png#clientId=u6ebc176c-d047-4&from=ui&id=uaf8cbc19&originHeight=304&originWidth=690&originalType=binary&ratio=1&rotation=0&showTitle=false&size=44410&status=done&style=none&taskId=ufa87f7f6-1ee2-4c58-9dd2-93f002d3a3a&title=)



在配置中心的鉴权方面，提供了三重防护方案，本文以 Nacos 配置中心为例：

- 在客户端，开源的 nacos-client 支持通过 AK/SK 方式进行配置的访问，针对开启配置鉴权的配置中心，如果以未授权的 AK/SK 或者没有带上 AK/SK 进行方案，则服务器端会直接拒绝该请求。
- 用户在配置管理控制台，提供基于阿里云 RAM 的权限控制台策略，配置中心鉴权功能可以按照实例、命名空间、**group**、**dataId**设置访问权限，降低某个实例被恶意用户非法获取、修改的风险；同时，所有的操作都提供了审计能力，方便进行溯源，查询历史的操作等动作。
- 针对 Nacos 服务器，节点之间信息同步，我们也添加了认证机制，防止未经授权的数据在集群之间同步。




